---
title: promise
date: 2017-01-24 11:11:13
categories:
  - å†å²
  - å‰ç«¯
tags:
- ES6
- promise
---
ç®€å•ä»‹ç»ä¸€ä¸‹promise
<!--more-->
### åŸºæœ¬ç”¨æ³•
```bash
let promise = new Promise((resolve,reject)=>{
    /**ä¸šåŠ¡å¤„ç†**/
    resolve(/**data**/);
})
promise.then((data)=>{
    /**æ•°æ®å¤„ç†**/
}).catch((err)=>{
    /**é”™è¯¯å¤„ç†**/
})
```

### promiseå¸¸è§„ç”¨æ³•

- promise.then

```bash
var promise = new Promise(resolve,reject){
    resolve('ä¼ é€’ç»™thençš„å€¼')
}
promise.then(function(data){
    console.log(data);
},function(error){
    console.log(error);
})
```

- promise.catch

```bash
var promise = new Promise(function(resolve, reject){
    resolve("ä¼ é€’ç»™thençš„å€¼");
});
promise.then(function (value) {
    console.log(value);
}).catch(function (error) {
    console.error(error);
});
```
- promise.resolve

```bash
function asyncTask(name){
    return Promise.resolve(name).then(function(value){
        return "Done"+value
    })
}
var taskName = "task 1";
asyncTask(taskName).then(function(value){
    console.log(value)
}).catch(function(err){
    console.log(err);
})
```

- promise.reject

```bash
var r = Promise.reject(new Error('err'))
```
- promise.all

```bash
var p1 = Promise.resolve(1),
    p2 = Promise.resolve(2),
    p3 = Promise.resolve(3);
Promise.all([p1, p2, p3]).then(function (results) {
    console.log(results);  // [1, 2, 3]
});
```
- promise.race

```bash
var p1 = Promise.resolve(1),
    p2 = Promise.resolve(2),
    p3 = Promise.resolve(3);
Promise.race([p1, p2, p3]).then(function (results) {
    console.log(results);  // [1]
});
```

### Promise.resolve()
*Promise.reject(error)æ˜¯å’Œ Promise.resolve(value) ç±»ä¼¼çš„<mark>é™æ€æ–¹æ³•</mark>ï¼Œæ˜¯ new Promise() æ–¹æ³•çš„å¿«æ·æ–¹å¼ã€‚*


```bash
    Promise.resolve(42).then(function(value){
    console.log(value);
});
```

> ç®€å•æ€»ç»“ä¸€ä¸‹ Promise.resolve æ–¹æ³•çš„è¯ï¼Œå¯ä»¥è®¤ä¸ºå®ƒçš„ä½œç”¨å°±æ˜¯å°†ä¼ é€’ç»™å®ƒçš„å‚æ•°å¡«å……ï¼ˆFulfilledï¼‰åˆ°promiseå¯¹è±¡åå¹¶è¿”å›è¿™ä¸ªpromiseå¯¹è±¡ã€‚
æ­¤å¤–ï¼ŒPromiseçš„å¾ˆå¤šå¤„ç†å†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨äº† Promise.resolve ç®—æ³•å°†å€¼è½¬æ¢ä¸ºpromiseå¯¹è±¡åå†è¿›è¡Œå¤„ç†çš„ã€‚

### Promise.reject()

```bash
Promise.reject(new Error("å‡ºé”™äº†"))
//æ˜¯ä¸‹é¢ä»£ç çš„è¯­æ³•ç³–
new Promise(function(resolve,reject){
    reject(new Error("å‡ºé”™äº†"));
});
```
> å®ƒå’ŒPromise.resolve(value) çš„ä¸åŒä¹‹å¤„åœ¨äºpromiseå†…è°ƒç”¨çš„å‡½æ•°æ˜¯rejectè€Œä¸æ˜¯resolveï¼Œè¿™åœ¨ç¼–å†™æµ‹è¯•ä»£ç æˆ–è€…è¿›è¡Œdebugæ—¶ï¼Œè¯´ä¸å®šä¼šç”¨å¾—ä¸Šã€‚


### å‡ ä¸ªå¾ˆé‡è¦çš„åŸåˆ™é—®é¢˜
- ç»å¯¹ä¸èƒ½å¯¹å¼‚æ­¥å›è°ƒå‡½æ•°ï¼ˆå³ä½¿åœ¨æ•°æ®å·²ç»å°±ç»ªï¼‰è¿›è¡ŒåŒæ­¥è°ƒç”¨ã€‚

- å¦‚æœå¯¹å¼‚æ­¥å›è°ƒå‡½æ•°è¿›è¡ŒåŒæ­¥è°ƒç”¨çš„è¯ï¼Œå¤„ç†é¡ºåºå¯èƒ½ä¼šä¸é¢„æœŸä¸ç¬¦ï¼Œå¯èƒ½å¸¦æ¥æ„æ–™ä¹‹å¤–çš„åæœã€‚

- å¯¹å¼‚æ­¥å›è°ƒå‡½æ•°è¿›è¡ŒåŒæ­¥è°ƒç”¨ï¼Œè¿˜å¯èƒ½å¯¼è‡´æ ˆæº¢å‡ºæˆ–å¼‚å¸¸å¤„ç†é”™ä¹±ç­‰é—®é¢˜ã€‚

- å¦‚æœæƒ³åœ¨å°†æ¥æŸæ—¶åˆ»è°ƒç”¨å¼‚æ­¥å›è°ƒå‡½æ•°çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ setTimeout ç­‰å¼‚æ­¥APIã€‚

**ç®€å•ä¸€å¥è¯ï¼šPromiseåªèƒ½ä½¿ç”¨å¼‚æ­¥è°ƒç”¨æ–¹å¼ ã€‚**

- ä¸åˆæ³•çš„è°ƒç”¨
```bash
function onReady(fn) {
    var readyState = document.readyState;
    if (readyState === 'interactive' || readyState === 'complete') {
        fn();
    } else {
        window.addEventListener('DOMContentLoaded', fn);
    }
}
onReady(function () {
    console.log('DOM fully loaded and parsed');
});
console.log('==Starting==');
//æ§åˆ¶å°æ‰“å°
DOM fully loaded and parsed
==Starting==
```
- ç¬¦åˆè§„èŒƒ
```bash
function onReady(fn) {
    var readyState = document.readyState;
    if (readyState === 'interactive' || readyState === 'complete') {
        setTimeout(fn, 0);
    } else {
        window.addEventListener('DOMContentLoaded', fn);
    }
}
onReady(function () {
    console.log('DOM fully loaded and parsed');
});
console.log('==Starting==');
//æ§åˆ¶å°æ‰“å°

<mark>Starting</mark>
DOM fully loaded and parsed
```
- ä¸Šè¿°ä¾‹å­ç”¨promiseé‡å†™
> ç”±äºPromiseä¿è¯äº†æ¯æ¬¡è°ƒç”¨éƒ½æ˜¯ä»¥å¼‚æ­¥æ–¹å¼è¿›è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®é™…ç¼–ç ä¸­ä¸éœ€è¦è°ƒç”¨ setTimeout æ¥è‡ªå·±å®ç°å¼‚æ­¥è°ƒç”¨ã€‚


```bash
function onReadyPromise() {
    return new Promise(function (resolve, reject) {
        var readyState = document.readyState;
        if (readyState === 'interactive' || readyState === 'complete') {
            resolve();
        } else {
            window.addEventListener('DOMContentLoaded', resolve);
        }
    });
}
onReadyPromise().then(function () {
    console.log('DOM fully loaded and parsed');
});
console.log('==Starting==');
```
å¯¹äºä¸ºä»€ä¹ˆè¯·çœ‹[è¿™é‡Œ](http://effectivejs.com/).

### promise chain
- åŸºæœ¬ç”¨æ³•
> åœ¨æœ¬ä¾‹ä¸­æˆ‘ä»¬åœ¨taskAä¸­ä½¿ç”¨äº† throw æ–¹æ³•æ•…æ„åˆ¶é€ äº†ä¸€ä¸ªå¼‚å¸¸ã€‚ä½†åœ¨å®é™…ä¸­æƒ³ä¸»åŠ¨è¿›è¡ŒonRejectedè°ƒç”¨çš„æ—¶å€™ï¼Œåº”è¯¥è¿”å›ä¸€ä¸ªRejectedçŠ¶æ€çš„promiseå¯¹è±¡ã€‚

```bash
function taskA() {
    console.log("Task A");
    throw new Error("throw Error @ Task A")
}
function taskB() {
    console.log("Task B");// ä¸ä¼šè¢«è°ƒç”¨
}
function onRejected(error) {
    console.log(error);// => "throw Error @ Task A"
}
function finalTask() {
    console.log("Final Task");
}

var promise = Promise.resolve();
promise
    .then(taskA)
    .then(taskB)
    .catch(onRejected)
    .then(finalTask);
//æ§åˆ¶å°æ‰“å°
Task A
Error: throw Error @ Task A
Final Task
```
- promise chain ä¸­å¦‚ä½•ä¼ é€’å‚æ•°
> å‰é¢ä¾‹å­ä¸­çš„Taskéƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œåªæ˜¯è¢«ç®€å•è°ƒç”¨è€Œå·²ã€‚
è¿™æ—¶å€™å¦‚æœ Task A æƒ³ç»™ Task B ä¼ é€’ä¸€ä¸ªå‚æ•°è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ
ç­”æ¡ˆéå¸¸ç®€å•ï¼Œé‚£å°±æ˜¯åœ¨ Task A ä¸­ return çš„è¿”å›å€¼ï¼Œä¼šåœ¨ Task B æ‰§è¡Œæ—¶ä¼ ç»™å®ƒã€‚

```bash
function doubleUp(value) {
    return value * 2;
}
function increment(value) {
    return value + 1;
}
function output(value) {
    console.log(value);// => (1 + 1) * 2
}

var promise = Promise.resolve(1);
promise
    .then(increment)
    .then(doubleUp)
    .then(output)
    .catch(function(error){
        // promise chainä¸­å‡ºç°å¼‚å¸¸çš„æ—¶å€™ä¼šè¢«è°ƒç”¨
        console.error(error);
    });
```
### Promise.catch()
> å®é™…ä¸Š Promise#catch åªæ˜¯ promise.then(undefined, onRejected); æ–¹æ³•çš„ä¸€ä¸ªåˆ«åè€Œå·²ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥æ³¨å†Œå½“promiseå¯¹è±¡çŠ¶æ€å˜ä¸ºRejectedæ—¶çš„å›è°ƒå‡½æ•°ã€‚

**åœ¨ECMAScript 3ä¸­ä¿ç•™å­—æ˜¯ä¸èƒ½ä½œä¸ºå¯¹è±¡çš„å±æ€§åä½¿ç”¨çš„ã€‚ è€ŒIE8åŠä»¥ä¸‹ç‰ˆæœ¬éƒ½æ˜¯åŸºäºECMAScript 3å®ç°çš„ï¼Œå› æ­¤ä¸èƒ½å°† catch ä½œä¸ºå±æ€§æ¥ä½¿ç”¨ï¼Œä¹Ÿå°±ä¸èƒ½ç¼–å†™ç±»ä¼¼ promise.catch() çš„ä»£ç ï¼Œå› æ­¤å°±å‡ºç°äº† identifier not found è¿™ç§è¯­æ³•é”™è¯¯äº†ã€‚
è€Œç°åœ¨çš„æµè§ˆå™¨éƒ½æ˜¯åŸºäºECMAScript 5çš„ï¼Œè€Œåœ¨ECMAScript 5ä¸­ä¿ç•™å­—éƒ½å±äº IdentifierName ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå±æ€§åä½¿ç”¨äº†ã€‚**
<mark>è§£å†³Promise#catchæ ‡è¯†ç¬¦å†²çªé—®é¢˜</mark>
- ä½¿ç”¨`[]`è€Œä¸ä½¿ç”¨`.`
```bash
var promise = Promise.reject(new Error("message"));
promise["catch"](function (error) {
    console.error(error);
});
```
- ä½¿ç”¨ thenä¹Ÿæ˜¯å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜çš„
```bash
var promise = Promise.reject(new Error("message"));
promise.then(undefined, function (error) {
    console.error(error);
});
```
### æ¯æ¬¡è°ƒç”¨thenéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„promiseå¯¹è±¡

```bash
// 1: å¯¹åŒä¸€ä¸ªpromiseå¯¹è±¡åŒæ—¶è°ƒç”¨ `then` æ–¹æ³•
var aPromise = new Promise(function (resolve) {
    resolve(100);
});
aPromise.then(function (value) {
    return value * 2;
});
aPromise.then(function (value) {
    return value * 2;
});
aPromise.then(function (value) {
    console.log("1: " + value); // => 100
})

// vs

// 2: å¯¹ `then` è¿›è¡Œ promise chain æ–¹å¼è¿›è¡Œè°ƒç”¨
var bPromise = new Promise(function (resolve) {
    resolve(100);
});
bPromise.then(function (value) {
    return value * 2;
}).then(function (value) {
    return value * 2;
}).then(function (value) {
    console.log("2: " + value); // => 100 * 2 * 2
});

//æ§åˆ¶å°æ‰“å°
1,100
2,400
```
> å¦‚æœæˆ‘ä»¬çŸ¥é“äº† `then` æ–¹æ³•æ¯æ¬¡éƒ½ä¼šåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª`æ–°`çš„promiseå¯¹è±¡çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥ä¸éš¾ç†è§£ä¸‹é¢ä»£ç ä¸­å¯¹` then` çš„ä½¿ç”¨æ–¹å¼ä¸Šçš„å·®åˆ«äº†

<mark>thenä¸€ä¸ªå¾ˆé‡è¦çš„åä¾‹</mark>
```bash
function badAsyncCall() {
    var promise = Promise.resolve();
    promise.then(function() {
        // ä»»æ„å¤„ç†
        return newVar;
    });
    return promise;
}
```
è¿™ç§å†™æ³•æœ‰å¾ˆå¤šé—®é¢˜ï¼Œé¦–å…ˆåœ¨ `promise.then` ä¸­äº§ç”Ÿçš„å¼‚å¸¸ä¸ä¼šè¢«å¤–éƒ¨æ•è·ï¼Œæ­¤å¤–ï¼Œä¹Ÿä¸èƒ½å¾—åˆ° `then` çš„è¿”å›å€¼ï¼Œå³ä½¿å…¶æœ‰è¿”å›å€¼ã€‚

ç”±äºæ¯æ¬¡ promise.then è°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„promiseå¯¹è±¡ï¼Œå› æ­¤éœ€è¦åƒä¸Šè¿°æ–¹å¼2é‚£æ ·ï¼Œé‡‡ç”¨promise chainçš„æ–¹å¼å°†è°ƒç”¨è¿›è¡Œé“¾å¼åŒ–ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

<mark>æ­£ç¡®å†™æ³•</mark>
```bash
function anAsyncCall() {
    var promise = Promise.resolve();
    return promise.then(function() {
        // ä»»æ„å¤„ç†
        return newVar;
    });
}

```
### Promise.all()

`Promise.all` æ¥æ”¶ä¸€ä¸ª `promiseå¯¹è±¡çš„æ•°ç»„`ä½œä¸ºå‚æ•°ï¼Œå½“è¿™ä¸ªæ•°ç»„é‡Œçš„æ‰€æœ‰promiseå¯¹è±¡å…¨éƒ¨å˜ä¸º`resolve`æˆ–`reject`çŠ¶æ€çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šå»è°ƒç”¨ `.then` æ–¹æ³•ã€‚

```bash
function getURL(URL) {
    return new Promise(function (resolve, reject) {
        var req = new XMLHttpRequest();
        req.open('GET', URL, true);
        req.onload = function () {
            if (req.status === 200) {
                resolve(req.responseText);
            } else {
                reject(new Error(req.statusText));
            }
        };
        req.onerror = function () {
            reject(new Error(req.statusText));
        };
        req.send();
    });
}
var request = {
        comment: function getComment() {
            return getURL('http://azu.github.io/promises-book/json/comment.json').then(JSON.parse);
        },
        people: function getPeople() {
            return getURL('http://azu.github.io/promises-book/json/people.json').then(JSON.parse);
        }
    };
function main() {
    //ä¸é‡‡ç”¨all
    /**
    function recordValue(results, value) {
        results.push(value);
        return results;
    }
    // [] ç”¨æ¥ä¿å­˜åˆå§‹åŒ–çš„å€¼
    var pushValue = recordValue.bind(null, []);
    return request.comment().then(pushValue).then(request.people).then(pushValue);
    **/
    return Promise.all([request.comment(), request.people()]);
}
// è¿è¡Œç¤ºä¾‹
main().then(function (value) {
    console.log(value);
}).catch(function(error){
    console.log(error);
});

```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`request.comment() `å’Œ `request.people()` ä¼šåŒæ—¶å¼€å§‹æ‰§è¡Œï¼Œè€Œä¸”æ¯ä¸ªpromiseçš„ç»“æœï¼ˆresolveæˆ–rejectæ—¶ä¼ é€’çš„å‚æ•°å€¼ï¼‰ï¼Œå’Œä¼ é€’ç»™ Promise.all çš„promiseæ•°ç»„çš„`é¡ºåºæ˜¯ä¸€è‡´`çš„ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ—¶å€™` .then` å¾—åˆ°çš„promiseæ•°ç»„çš„æ‰§è¡Œç»“æœçš„é¡ºåºæ˜¯`å›ºå®š`çš„ï¼Œå³` [comment, people]`ã€‚
```bash
main().then(function (results) {
    console.log(results); // æŒ‰ç…§[comment, people]çš„é¡ºåº
});
```
æ —å­ğŸŒ°

```bash
// `delay`æ¯«ç§’åæ‰§è¡Œresolve
function timerPromisefy(delay) {
    return new Promise(function (resolve) {
        setTimeout(function () {
            resolve(delay);
        }, delay);
    });
}
var startDate = Date.now();
// æ‰€æœ‰promiseå˜ä¸ºresolveåç¨‹åºé€€å‡º
Promise.all([
    timerPromisefy(1),
    timerPromisefy(32),
    timerPromisefy(64),
    timerPromisefy(128)
]).then(function (values) {
    console.log(Date.now() - startDate + 'ms');
    // ç´„128ms
    console.log(values);    // [1,32,64,128]
});
//å¯ç”¨äºå¤šä¸ªè¯·æ±‚ä¹‹åï¼Œå…³é—­å¼¹å‡ºæ¡†ä¹‹ç±»çš„ä¸šåŠ¡
```
### Promise.race()
`Promise.all` åœ¨æ¥æ”¶åˆ°çš„æ‰€æœ‰çš„å¯¹è±¡promiseéƒ½å˜ä¸º FulFilled æˆ–è€… Rejected çŠ¶æ€ä¹‹åæ‰ä¼šç»§ç»­è¿›è¡Œåé¢çš„å¤„ç†ï¼Œ ä¸ä¹‹ç›¸å¯¹çš„æ˜¯ `Promise.race` åªè¦æœ‰ä¸€ä¸ªpromiseå¯¹è±¡è¿›å…¥ FulFilled æˆ–è€… Rejected çŠ¶æ€çš„è¯ï¼Œå°±ä¼šç»§ç»­è¿›è¡Œåé¢çš„å¤„ç†ã€‚

```bash
// `delay`æ¯«ç§’åæ‰§è¡Œresolve
function timerPromisefy(delay) {
    return new Promise(function (resolve) {
        setTimeout(function () {
            resolve(delay);
        }, delay);
    });
}
// ä»»ä½•ä¸€ä¸ªpromiseå˜ä¸ºresolveæˆ–reject çš„è¯ç¨‹åºå°±åœæ­¢è¿è¡Œ
Promise.race([
    timerPromisefy(1),
    timerPromisefy(32),
    timerPromisefy(64),
    timerPromisefy(128)
]).then(function (value) {
    console.log(value);    // => 1
});
```

```bash
var winnerPromise = new Promise(function (resolve) {
        setTimeout(function () {
            console.log('this is winner');
            resolve('this is winner');
        }, 4);
    });
var loserPromise = new Promise(function (resolve) {
        setTimeout(function () {
            console.log('this is loser');
            resolve('this is loser');
        }, 1000);
    });
// ç¬¬ä¸€ä¸ªpromiseå˜ä¸ºresolveåç¨‹åºåœæ­¢
Promise.race([winnerPromise, loserPromise]).then(function (value) {
    console.log(value);    // => 'this is winner'
});
```
`Promise.race`å¹¶ä¸ä¼šåœ¨ç¬¬ä¸€ä¸ªpromiseå˜ä¸ºFulfilledæ—¶ï¼Œå–æ¶ˆå…¶ä»–promiseçš„è¿è¡Œï¼Œ~~ä½†æ˜¯resolveçš„ç»“æœå´æ˜¯åªæœ‰ç¬¬ä¸€ä¸ªçš„ï¼Œèµ›è·‘èµ›è·‘ï¼‰~~

### ä¸èƒ½è¿›è¡Œé”™è¯¯å¤„ç†çš„onRejected

```bash
function throwError(value) {
    // æŠ›å‡ºå¼‚å¸¸
    throw new Error(value);
}
// <1> onRejectedä¸ä¼šè¢«è°ƒç”¨
function badMain(onRejected) {
    return Promise.resolve(42).then(throwError, onRejected);
}
// <2> æœ‰å¼‚å¸¸å‘ç”Ÿæ—¶onRejectedä¼šè¢«è°ƒç”¨
function goodMain(onRejected) {
    return Promise.resolve(42).then(throwError).catch(onRejected);
}
// è¿è¡Œç¤ºä¾‹
badMain(function(){
    console.log("BAD");
});
goodMain(function(){
    console.log("GOOD");
});
```
> ä¸ºä»€ä¹ˆè¯´ `badMain` ä¸å¥½å‘¢ï¼Ÿï¼Œå› ä¸ºè™½ç„¶æˆ‘ä»¬åœ¨`.then` çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­æŒ‡å®šäº†ç”¨æ¥é”™è¯¯å¤„ç†çš„å‡½æ•°ï¼Œä½†å®é™…ä¸Šå®ƒå´ä¸èƒ½æ•è·ç¬¬ä¸€ä¸ªå‚æ•° `onFulfilled` æŒ‡å®šçš„å‡½æ•°ï¼ˆæœ¬ä¾‹ä¸º `throwError` ï¼‰é‡Œé¢å‡ºç°çš„é”™è¯¯ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ—¶å€™å³ä½¿ `throwError` æŠ›å‡ºäº†å¼‚å¸¸ï¼ŒonRejected æŒ‡å®šçš„å‡½æ•°ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ï¼ˆå³ä¸ä¼šè¾“å‡º`"BAD"`å­—æ ·ï¼‰ã€‚
ä¸æ­¤ç›¸å¯¹çš„æ˜¯ï¼Œ `goodMain` çš„ä»£ç åˆ™éµå¾ªäº† `throwErrorâ†’onRejected` çš„è°ƒç”¨æµç¨‹ã€‚ è¿™æ—¶å€™ `throwError` ä¸­å‡ºç°å¼‚å¸¸çš„è¯ï¼Œåœ¨ä¼šè¢«æ–¹æ³•é“¾ä¸­çš„ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼Œå³ `.catch` æ‰€æ•è·ï¼Œè¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ã€‚

**æˆ‘ä»¬éœ€è¦æ³¨æ„å¦‚æœä»£ç ç±»ä¼¼ badMain é‚£æ ·çš„è¯ï¼Œå°±å¯èƒ½å‡ºç°ç¨‹åºä¸ä¼šæŒ‰é¢„æœŸè¿è¡Œçš„æƒ…å†µï¼Œä»è€Œä¸èƒ½æ­£ç¡®çš„è¿›è¡Œé”™è¯¯å¤„ç†ã€‚**

### ç®€å•çš„thenable

```bash
// è¿”å› `thenable`
function notifyMessageAsThenable(message, options) {
    return {
        'then': function (resolve, reject) {
            notifyMessage(message, options, function (error, notification) {
                if (error) {
                    reject(error);
                } else {
                    resolve(notification);
                }
            });
        }
    };
}
// è¿è¡Œç¤ºä¾‹
Promise.resolve(notifyMessageAsThenable("message")).then(function (notification) {
    console.log(notification);// é€šçŸ¥å¯¹è±¡
}).catch(function(error){
    console.error(error);
});
```

### Deferredå’ŒPromiseçš„å…³ç³»

![image](http://liubin.org/promises-book/Ch4_AdvancedPromises/img/deferred-and-promise.png)

### è®©Promiseç­‰å¾…æŒ‡å®šæ—¶é—´
- ç®€å•çš„ğŸŒ°
```bash
function delayPromise(ms){
    return new Promise(function(){
        setTimeout(resolve,ms);
    })
}
//æ —å­ğŸŒ°
delayPromise(100).then(function(){
    alert('å·²ç»å»¶è¿Ÿ100ms')
)
```
-  Promise.raceä¸­çš„è¶…æ—¶

```bash
function delayPromise(ms) {
    return new Promise(function (resolve) {
        setTimeout(resolve, ms);
    });
}
function timeoutPromise(promise, ms) {
    var timeout = delayPromise(ms).then(function () {
            throw new Error('Operation timed out after ' + ms + ' ms');
        });
    return Promise.race([promise, timeout]);
}
// è¿è¡Œç¤ºä¾‹
var taskPromise = new Promise(function(resolve){
    // éšä¾¿ä¸€äº›ä»€ä¹ˆå¤„ç†
    var delay = Math.random() * 2000;
    setTimeout(function(){
        resolve(delay + "ms");
    }, delay);
});
timeoutPromise(taskPromise, 1000).then(function(value){
    console.log("taskPromiseåœ¨è§„å®šæ—¶é—´å†…ç»“æŸ : " + value);
}).catch(function(error){
    console.log("å‘ç”Ÿè¶…æ—¶", error);
});
```












[](http://liubin.org/promises-book/#promises-aplus)




